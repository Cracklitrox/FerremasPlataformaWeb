{% extends 'base_usuario.html' %}
{% load static %}
{% block css_cliente %}
<link rel="stylesheet" href="{% static 'css/cliente/index_cliente.css' %}">
{% endblock %}

{% block title %}
{% endblock %}

{% block cliente %}
<!-- Id Usuario -->
{% if cliente_id %}
<input type="hidden" id="user-id" value="{{ cliente_id }}">
{% endif %}
<!-- -main-nav - -->

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container px-4 px-lg-5">
        <div>
            <h1 class="text-success">Ferremas</h1>
        </div>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
                <li class="nav-item"><a href="{% url 'index_cliente' %}" class="nav-link active" aria-current="page">Inicio</a></li>
                <li class="nav-item"><a href="{% url 'contacto_cliente' %}" class="nav-link" >Sobre Nosotros</a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Tienda</a>
                    <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <li><a class="dropdown-item" href="{% url 'catalogo_productos' %}">Productos</a></li>
                        <li><hr class="dropdown-divider" /></li>
                        <li><a class="dropdown-item" href="{% url 'productos_nuevos' %}">Últimos productos</a></li>
                    </ul>
                </li>
            </ul>
            <div class="d-flex">
                {% if request.session.is_cliente_logged_in %}
                <a id="cart-icon" href="#" class="btn btn-outline-dark me-2">
                    <i class="fas fa-shopping-cart"></i>
                    Carrito
                </a>
                <a id="notificaciones-icon" class="btn btn-outline-dark me-2" data-bs-toggle="popover" title="Notificaciones">
                    <i class="fas fa-bell"></i>
                    Notificaciones
                    <span class="badge bg-secondary" id="notificaciones-badge">0</span>
                </a>
                <a id="recibo-icon" class="btn btn-outline-dark me-2">
                    <i class="fas fa-receipt"></i>
                    Recibos
                </a>
                <form id="logout-form" action="{% url 'cerrar_sesion_cliente' %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning" id="logout-button" onclick="return confirm('¿Estás seguro que deseas cerrar sesión?');">Cerrar Sesión</button>
                </form>
                {% else %}
                <a href="{% url 'logueo_cliente' %}" class="text-decoration-none text-dark me-2">
                    <i class="fas fa-sign-in-alt"></i>
                </a>
                <a href="{% url 'register_cliente' %}" class="text-decoration-none text-dark me-2">
                    <i class="fas fa-user-plus"></i>
                </a>
                {% endif %}
            </div>
            <div id="notificaciones-content" class="d-none">
                <!-- Aquí se mostrarán las notificaciones -->
            </div>
        </div>
    </div>
</nav>

<div id="sidebar" class="sidebar">
    <ul id="cart-items">
        <!-- Aquí van los items del carrito -->
    </ul>
    <div id="empty-message" class="empty-message">Aún no hay productos agregados.</div>
    <div class="sidebar-footer">
        <!-- Mostrar el monto total acumulado -->
        <div id="total-amount" class="total-amount">Total: 0</div>
        <div class="button-container d-flex justify-content-between">
            <button id="close-btn" class="btn btn-secondary">Cerrar</button>
            <button id="clear-cart-btn" class="btn btn-danger" style="display: none;">Eliminar todos los productos</button>
            <button id="buy-btn" class="btn btn-success">Comprar</button>
        </div>
    </div>
</div>
{% endblock %}
{% block cliente_footer %}
<!-- Footer -->
<footer class="bg-dark text-light py-4">
    <div class="container text-center">
        <p>&copy; 2024 Ferremas. Todos los derechos reservados.</p>
        <!-- Agrega aquí otros elementos del footer, como enlaces a redes sociales o información de contacto -->
    </div>
</footer>
{% endblock %}
{% block js_cliente %}
<script src="https://kit.fontawesome.com/d33f2bbb0e.js" crossorigin="anonymous"></script>
<script src="{% static 'js/cliente/index_cliente.js' %}"></script>
<script>
    $(document).ready(function() {
        // Inicializar popover
        $('#notificaciones-icon').popover({
            html: true,
            content: function() {
                return $('#notificaciones-content').html();
            }
        });
    
        // Mostrar notificaciones al hacer clic en el icono de notificaciones
        $('#notificaciones-icon').on('click', function() {
            // Cargar las notificaciones si aún no están cargadas
            if ($('#notificaciones-content').is(':empty')) {
                cargarNotificaciones();
            }
        });
    });
    
    function cargarNotificaciones() {
        const clienteId = $('#user-id').val();
        console.log(`Cargando notificaciones para el cliente ${clienteId}`);
    
        fetch(`/cliente/notificaciones/${clienteId}/`)
            .then(response => response.json())
            .then(data => {
                console.log('Datos recibidos:', data);
    
                // Generar HTML para las notificaciones
                let html = '';
                data.notificaciones.forEach(notificacion => {
                    html += `<div class="notificacion-item">${notificacion.id} - ${notificacion.estado}</div>`;
                });
                $('#notificaciones-content').html(html);
                $('#notificaciones-badge').text(data.notificaciones.length); // Actualizar el número de notificaciones en el badge
                $('#notificaciones-content').removeClass('d-none'); // Mostrar el contenido del popover
    
                console.log('Notificaciones cargadas correctamente.');
            })
            .catch(error => {
                console.error('Error al cargar notificaciones:', error);
            });
    }
</script>
{% endblock %}